<!-- Inlined to avoid FOUC. This is a parser blocking script. -->
<script is:inline>
	(() => {
		if (window.__themeProviderInit) {
			return;
		}
		window.__themeProviderInit = true;

		const darkModePref = window.matchMedia("(prefers-color-scheme: dark)");
		const themeValues = new Set(["light", "dark", "system"]);

		function normalizeTheme(value) {
			return themeValues.has(value) ? value : "system";
		}

		function getStoredTheme() {
			if (typeof localStorage === "undefined") {
				return "system";
			}
			return normalizeTheme(localStorage.getItem("theme"));
		}

		function getResolvedTheme(theme) {
			if (theme === "dark") {
				return "dark";
			}
			if (theme === "light") {
				return "light";
			}
			return darkModePref.matches ? "dark" : "light";
		}

		function applyTheme(theme, { persist = true } = {}) {
			const root = document.documentElement;
			const resolvedTheme = getResolvedTheme(theme);

			if (root.getAttribute("data-theme") !== theme) {
				root.setAttribute("data-theme", theme);
			}
			if (root.getAttribute("data-theme-resolved") !== resolvedTheme) {
				root.setAttribute("data-theme-resolved", resolvedTheme);
			}

			if (persist && typeof localStorage !== "undefined") {
				localStorage.setItem("theme", theme);
			}

			return resolvedTheme;
		}

		function emitThemeChange(theme, resolvedTheme, source) {
			document.dispatchEvent(
				new CustomEvent("theme-change", {
					detail: {
						theme,
						resolvedTheme,
						source,
					},
				}),
			);
		}

		const applyStoredTheme = () => {
			applyTheme(getStoredTheme(), { persist: false });
		};

		// initial setup
		applyStoredTheme();

		// View Transitions hook to restore theme
		document.addEventListener("astro:after-swap", applyStoredTheme);

		// listen for theme-change custom event, fired in src/components/ThemeToggle.astro
		document.addEventListener("theme-change", (event) => {
			if (event.detail?.source === "system") {
				return;
			}
			applyTheme(normalizeTheme(event.detail?.theme), { persist: true });
		});

		// listen for prefers-color-scheme change while on system
		darkModePref.addEventListener("change", () => {
			const rootTheme = normalizeTheme(document.documentElement.getAttribute("data-theme"));
			if (rootTheme !== "system") {
				return;
			}
			emitThemeChange(rootTheme, applyTheme(rootTheme, { persist: false }), "system");
		});
	})();
</script>
