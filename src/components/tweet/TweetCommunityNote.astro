---
import type { BirdwatchPivot } from "@/components/tweet/api.ts";
import TweetLink from "./TweetLink.astro";

interface Props {
	pivot: BirdwatchPivot;
}

const { pivot } = Astro.props;
const noteTitle = pivot.shorttitle ?? pivot.title;
const renderHtmlWithBreaks = (text: string) => text.replaceAll("\n", "<br />");
const noteSubtitle = pivot.subtitle;
const subtitleText = noteSubtitle?.text ?? "";
const subtitleEntities =
	noteSubtitle?.entities
		?.map((entity) => ({
			start: entity.fromIndex,
			end: entity.toIndex,
			href: entity.ref.url?.url ?? "",
		}))
		.filter((entity) => entity.href.length > 0 && entity.end > entity.start)
		.sort((a, b) => a.start - b.start) ?? [];
const subtitleChars = Array.from(subtitleText);
const subtitleParts: Array<{ text: string; href?: string }> = [];

if (subtitleText) {
	let cursor = 0;

	for (const entity of subtitleEntities) {
		if (entity.start > cursor) {
			subtitleParts.push({ text: subtitleChars.slice(cursor, entity.start).join("") });
		}
		subtitleParts.push({
			text: subtitleChars.slice(entity.start, entity.end).join(""),
			href: entity.href,
		});
		cursor = entity.end;
	}

	if (cursor < subtitleChars.length) {
		subtitleParts.push({ text: subtitleChars.slice(cursor).join("") });
	}
}
---

<aside class="tweet-community-note" aria-label="Community note">
	<a
		href={pivot.destinationUrl}
		class="tweet-community-note-header"
		target="_blank"
		rel="noopener noreferrer nofollow"
	>
		<span class="tweet-community-note-icon" aria-hidden="true">
			<svg viewBox="0 0 24 24" role="img" focusable="false">
				<path
					d="M5.5 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm18.25 13.91c-.18-2.01-.78-3.72-1.81-4.96C20.89 10.7 19.45 10 17.75 10c-.35 0-.68.03-1.01.09-.18.54-.45 1.05-.8 1.49.74.46 1.41 1.05 1.99 1.76 1.05 1.3 1.71 2.91 2.06 4.66h3.85l-.09-1.09zM18.5 9c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zM6.07 13.34c.58-.71 1.25-1.3 1.99-1.76-.35-.44-.62-.95-.8-1.49-.33-.06-.66-.09-1.01-.09-1.7 0-3.14.7-4.19 1.95C1.032 13.19.433 14.9.254 16.91L.157 18H4.01c.35-1.75 1.01-3.36 2.06-4.66zM15 8.5c0-1.66-1.34-3-3-3s-3 1.34-3 3 1.34 3 3 3 3-1.34 3-3zm-7.37 6.1c-1.07 1.32-1.69 3.15-1.88 5.31L5.66 21h12.68l-.09-1.09c-.19-2.16-.81-3.99-1.88-5.31-1.08-1.35-2.59-2.1-4.37-2.1s-3.28.75-4.37 2.1z"
				></path>
			</svg>
		</span>
		{noteTitle && <p class="tweet-community-note-title">{noteTitle}</p>}
	</a>
	<div class="tweet-community-note-body">
		{
			subtitleParts.length > 0 && (
				<p class="tweet-community-note-subtitle">
					{subtitleParts.map((part) =>
						part.href ? (
							<TweetLink href={part.href} className="tweet-community-note-link">
								<span set:html={renderHtmlWithBreaks(part.text)} />
							</TweetLink>
						) : (
							<span set:html={renderHtmlWithBreaks(part.text)} />
						),
					)}
				</p>
			)
		}
	</div>
</aside>
